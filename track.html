<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Track Your Ride ‚Äî RCC Transportation</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --gold:#B8962E; --navy:#1B2040; --green:#27864A; --cream:#FDFAF3;
    --border:#e0ddd0; --text-dark:#1B2040; --text-light:#7A7565; --radius:10px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Outfit',sans-serif;background:var(--cream);color:var(--text-dark);min-height:100vh;}
  .header{background:var(--navy);color:white;padding:20px 24px;text-align:center;}
  .header h1{font-size:20px;font-weight:600;margin-bottom:4px;}
  .header .subtitle{font-size:13px;color:rgba(255,255,255,0.6);}
  .container{max-width:600px;margin:0 auto;padding:16px;}
  .info-card{background:white;border-radius:var(--radius);border:1px solid var(--border);padding:20px;margin-bottom:16px;box-shadow:0 2px 8px rgba(0,0,0,0.04);}
  .info-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid #f5f3ec;font-size:14px;}
  .info-row:last-child{border-bottom:none;}
  .info-label{color:var(--text-light);}
  .info-value{font-weight:500;text-align:right;max-width:60%;}
  #map{width:100%;height:400px;border-radius:var(--radius);border:1px solid var(--border);margin-bottom:16px;}
  .status-bar{padding:16px 18px;border-radius:var(--radius);text-align:center;font-size:14px;font-weight:500;margin-bottom:16px;transition:all 0.3s;}
  .status-waiting{background:#FFF8E1;color:#F9A825;border:1px solid #FFE082;}
  .status-enroute{background:#E8F5ED;color:var(--green);border:1px solid #A5D6A7;}
  .status-arrived{background:#E3F2FD;color:#1565C0;border:1px solid #90CAF9;animation:pulse 2s infinite;}
  .eta-box{text-align:center;padding:24px;background:white;border-radius:var(--radius);border:1px solid var(--border);margin-bottom:16px;}
  .eta-time{font-size:48px;font-weight:700;color:var(--navy);}
  .eta-label{font-size:13px;color:var(--text-light);margin-top:4px;}
  .eta-dist{font-size:14px;color:var(--gold);font-weight:600;margin-top:8px;}
  .footer{text-align:center;padding:20px;font-size:12px;color:var(--text-light);}
  .last-update{text-align:center;font-size:11px;color:var(--text-light);margin-top:-10px;margin-bottom:12px;}
  @keyframes pulse{0%,100%{box-shadow:0 0 0 0 rgba(21,101,192,0.3);}50%{box-shadow:0 0 0 12px rgba(21,101,192,0);}}
  .spinner-lg{width:48px;height:48px;border:4px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 16px;}
  @keyframes spin{to{transform:rotate(360deg);}}
</style>
</head>
<body>

<div class="header">
  <h1>üöê Track Your Ride</h1>
  <div class="subtitle">Redeemers Church of Christ ‚Äî Transportation Department</div>
</div>

<div class="container">
  <div id="statusBar" class="status-bar status-waiting">
    <div class="spinner-lg" style="margin-bottom:8px;width:24px;height:24px;border-width:2px;display:inline-block;vertical-align:middle;margin-right:8px;"></div>
    Waiting for your driver to start the route...
  </div>

  <div class="eta-box" id="etaBox" style="display:none;">
    <div class="eta-time" id="etaTime">--</div>
    <div class="eta-label">minutes away</div>
    <div class="eta-dist" id="etaDist"></div>
  </div>

  <div id="map"></div>
  <div class="last-update" id="lastUpdate"></div>

  <div class="info-card">
    <div class="info-row"><span class="info-label">Your Name</span><span class="info-value" id="riderName">--</span></div>
    <div class="info-row"><span class="info-label">Driver</span><span class="info-value" id="driverName">--</span></div>
    <div class="info-row"><span class="info-label">Pickup Address</span><span class="info-value" id="pickupAddr">--</span></div>
    <div class="info-row"><span class="info-label">Status</span><span class="info-value" id="rideStatus">Waiting for driver</span></div>
  </div>

  <div class="footer">
    Redeemers Church of Christ ¬∑ Transportation Department<br>
    10001 Aerospace Road, Lanham, MD 20706<br>
    <a href="mailto:bookaride@redeemerschapel.org" style="color:var(--gold);">bookaride@redeemerschapel.org</a>
  </div>
</div>

<script>
var PROXY = 'https://clickup-proxy.subscriptions-34a.workers.dev';

// Parse URL params
var params = new URLSearchParams(window.location.search);
var sessionId = params.get('session') || '';
var driverNameParam = params.get('driver') || 'Your Driver';
var destAddress = params.get('dest') || '';
var riderNameParam = params.get('name') || '';

document.getElementById('driverName').textContent = driverNameParam;
document.getElementById('pickupAddr').textContent = destAddress;
document.getElementById('riderName').textContent = riderNameParam;
document.title = 'Tracking ' + driverNameParam + ' ‚Äî RCC';

var map, driverMarker, destMarker, routeRenderer;
var destLatLng = null;
var pollInterval = null;
var hasArrived = false;

function initMap() {
  var geocoder = new google.maps.Geocoder();

  geocoder.geocode({ address: destAddress }, function(results, status) {
    destLatLng = (status === 'OK' && results[0]) ? results[0].geometry.location : new google.maps.LatLng(38.9847, -76.8545);

    map = new google.maps.Map(document.getElementById('map'), {
      center: destLatLng,
      zoom: 14,
      styles: [{ featureType:'poi', stylers:[{visibility:'off'}] }],
      disableDefaultUI: true,
      zoomControl: true,
      mapTypeControl: false,
    });

    // Rider's pickup location marker
    destMarker = new google.maps.Marker({
      position: destLatLng,
      map: map,
      title: 'Your Pickup Location',
      label: { text: 'üè†', fontSize: '24px' },
      icon: {
        path: google.maps.SymbolPath.CIRCLE,
        scale: 0,
      },
    });

    // Also add a circle to highlight pickup area
    new google.maps.Circle({
      center: destLatLng,
      radius: 50,
      map: map,
      fillColor: '#E53935',
      fillOpacity: 0.15,
      strokeColor: '#E53935',
      strokeWeight: 2,
      strokeOpacity: 0.5,
    });

    // Start polling for driver location every 5 seconds
    pollDriverLocation();
    pollInterval = setInterval(pollDriverLocation, 5000);
  });
}

async function pollDriverLocation() {
  if (hasArrived) return;

  try {
    // First check if this rider has been marked as picked up
    var pickupRes = await fetch(PROXY + '/tracking/pickup-status?sessionId=' + encodeURIComponent(sessionId) + '&riderName=' + encodeURIComponent(riderNameParam));
    var pickupData = await pickupRes.json();

    if (pickupData.pickedUp) {
      hasArrived = true;
      if (pollInterval) clearInterval(pollInterval);
      document.getElementById('statusBar').className = 'status-bar status-arrived';
      document.getElementById('statusBar').innerHTML = '‚úÖ <strong>You\'ve been picked up!</strong> Enjoy the ride to church.';
      document.getElementById('rideStatus').textContent = 'Picked Up';
      document.getElementById('etaBox').style.display = '';
      document.getElementById('etaTime').textContent = '‚úì';
      document.getElementById('etaDist').textContent = 'Tracking session ended';
      document.getElementById('lastUpdate').textContent = '';
      return;
    }

    var res = await fetch(PROXY + '/tracking/location?sessionId=' + encodeURIComponent(sessionId) + '&driverName=' + encodeURIComponent(driverNameParam));
    var data = await res.json();

    if (!data.location) return; // No location yet

    var loc = data.location;
    var driverLatLng = new google.maps.LatLng(loc.lat, loc.lng);
    var updateTime = new Date(loc.timestamp).toLocaleTimeString();

    // Update driver name if available
    if (loc.driverName) {
      document.getElementById('driverName').textContent = loc.driverName;
    }

    // Show status as en route
    document.getElementById('statusBar').className = 'status-bar status-enroute';
    document.getElementById('statusBar').innerHTML = 'üöê <strong>' + (loc.driverName || driverNameParam) + ' is on the way!</strong>';
    document.getElementById('rideStatus').textContent = 'En Route';
    document.getElementById('lastUpdate').textContent = 'Last updated: ' + updateTime;

    // Create or move driver marker
    if (!driverMarker) {
      driverMarker = new google.maps.Marker({
        position: driverLatLng,
        map: map,
        title: loc.driverName || driverNameParam,
        label: { text: 'üöê', fontSize: '28px' },
        icon: {
          path: google.maps.SymbolPath.CIRCLE,
          scale: 0,
        },
      });

      // Fit bounds
      var bounds = new google.maps.LatLngBounds();
      bounds.extend(driverLatLng);
      bounds.extend(destLatLng);
      map.fitBounds(bounds, 80);
    } else {
      // Smooth animation
      animateMarker(driverMarker, driverMarker.getPosition(), driverLatLng);
    }

    // Get route and ETA
    var directionsService = new google.maps.DirectionsService();
    directionsService.route({
      origin: driverLatLng,
      destination: destLatLng,
      travelMode: google.maps.TravelMode.DRIVING,
    }, function(result, status) {
      if (status !== 'OK') return;

      // Draw route
      if (routeRenderer) routeRenderer.setMap(null);
      routeRenderer = new google.maps.DirectionsRenderer({
        map: map,
        directions: result,
        suppressMarkers: true,
        polylineOptions: { strokeColor: '#1E88E5', strokeWeight: 5, strokeOpacity: 0.7 },
      });

      var leg = result.routes[0].legs[0];
      var etaMin = Math.ceil(leg.duration.value / 60);
      var distMi = (leg.distance.value / 1609.34).toFixed(1);

      document.getElementById('etaBox').style.display = '';
      document.getElementById('etaTime').textContent = etaMin;
      document.getElementById('etaDist').textContent = distMi + ' miles away';

      // Check if arrived (within 200 meters)
      if (leg.distance.value < 200) {
        hasArrived = true;
        document.getElementById('statusBar').className = 'status-bar status-arrived';
        document.getElementById('statusBar').innerHTML = 'üéâ <strong>Your driver has arrived!</strong> Please head outside.';
        document.getElementById('rideStatus').textContent = 'Arrived!';
        document.getElementById('etaTime').textContent = '0';
        document.getElementById('etaDist').textContent = 'Your driver is here!';

        // Vibrate if supported
        if (navigator.vibrate) navigator.vibrate([200, 100, 200, 100, 200]);
      }
    });

  } catch (err) {
    console.warn('Poll failed:', err);
  }
}

function animateMarker(marker, from, to) {
  var steps = 20;
  var step = 0;
  var fromLat = from.lat();
  var fromLng = from.lng();
  var toLat = to.lat();
  var toLng = to.lng();

  var timer = setInterval(function() {
    step++;
    var pct = step / steps;
    var lat = fromLat + (toLat - fromLat) * pct;
    var lng = fromLng + (toLng - fromLng) * pct;
    marker.setPosition(new google.maps.LatLng(lat, lng));
    if (step >= steps) clearInterval(timer);
  }, 50);
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6aFSYheMeqE7NUs3zZolyxPojLQuTqg4&libraries=places,directions&callback=initMap"></script>

</body>
</html>
