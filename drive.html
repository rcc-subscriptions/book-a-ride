<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Your Route ‚Äî RCC Transportation</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--gold:#B8962E;--gold-light:#D4B44A;--gold-pale:#F5EDD4;--navy:#1B2040;--green:#27864A;--green-bg:#E8F5ED;--red:#C0392B;--border:#e0ddd0;--cream:#FDFAF3;--text-dark:#1B2040;--text-light:#7A7565;--radius:10px;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Outfit',sans-serif;background:var(--cream);color:var(--text-dark);min-height:100vh;}
  .header{background:var(--navy);color:white;padding:16px 20px;}
  .header h1{font-size:18px;font-weight:600;}
  .header .sub{font-size:12px;color:rgba(255,255,255,0.6);margin-top:2px;}
  .header .driver-badge{display:inline-block;background:var(--gold);color:var(--navy);padding:4px 12px;border-radius:16px;font-size:12px;font-weight:700;margin-top:8px;}
  .container{max-width:600px;margin:0 auto;padding:16px;}
  .panel{background:white;border-radius:var(--radius);border:1px solid var(--border);margin-bottom:14px;overflow:hidden;box-shadow:0 2px 8px rgba(0,0,0,0.04);}
  .panel-head{padding:14px 16px;border-bottom:1px solid var(--border);font-weight:600;font-size:14px;display:flex;align-items:center;justify-content:space-between;}
  .panel-body{padding:16px;}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 16px;border:none;border-radius:var(--radius);cursor:pointer;font-family:inherit;font-size:13px;font-weight:600;transition:all 0.2s;width:100%;justify-content:center;}
  .btn-green{background:var(--green);color:white;} .btn-green:hover{background:#2ea055;}
  .btn-navy{background:var(--navy);color:white;} .btn-navy:hover{background:#2a3060;}
  .btn-red{background:var(--red);color:white;} .btn-red:hover{background:#e74c3c;}
  .btn-gold{background:var(--gold);color:white;} .btn-gold:hover{background:var(--gold-light);}
  .btn:disabled{opacity:0.5;cursor:not-allowed;}
  .btn-sm{width:auto;padding:7px 14px;font-size:12px;}
  #map{width:100%;height:300px;border-radius:var(--radius);border:1px solid var(--border);margin-bottom:14px;}
  .stop-card{border:1px solid var(--border);border-radius:var(--radius);padding:12px 14px;margin-bottom:10px;transition:all 0.2s;}
  .stop-card.picked{opacity:0.45;border-left:4px solid var(--green);}
  .stop-num{display:inline-flex;align-items:center;justify-content:center;width:24px;height:24px;border-radius:50%;color:white;font-size:11px;font-weight:700;margin-right:8px;flex-shrink:0;}
  .stop-name{font-weight:600;font-size:14px;}
  .stop-addr{font-size:12px;color:var(--text-light);margin-top:2px;}
  .stop-meta{font-size:11px;color:var(--text-light);margin-top:2px;}
  .stop-actions{margin-top:8px;display:flex;gap:8px;}
  .status-bar{padding:10px 14px;border-radius:var(--radius);font-size:13px;margin-bottom:14px;text-align:center;}
  .status-live{background:var(--green-bg);color:var(--green);}
  .status-off{background:#f5f3ec;color:var(--text-light);}
  .toast{position:fixed;bottom:16px;left:16px;right:16px;background:var(--navy);color:white;padding:12px 20px;border-radius:var(--radius);font-size:13px;text-align:center;z-index:9999;opacity:0;transition:opacity 0.3s;pointer-events:none;}
  .toast.show{opacity:1;}
  .spinner{width:18px;height:18px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;}
  @keyframes spin{to{transform:rotate(360deg);}}
  .church-card{padding:10px 14px;background:var(--green-bg);border-radius:var(--radius);font-size:13px;margin-bottom:8px;}
</style>
</head>
<body>

<div class="header">
  <h1>üöê Your Pickup Route</h1>
  <div class="sub">Redeemers Church of Christ ‚Äî Transportation</div>
  <div class="driver-badge" id="driverBadge">Loading...</div>
</div>

<div class="container">

  <div id="statusBar" class="status-bar status-off">Tap "Start Sharing Location" to begin</div>

  <div class="panel" id="phonePanel">
    <div class="panel-head">
      <span>üì± Your Phone Number</span>
    </div>
    <div class="panel-body">
      <p style="font-size:12px;color:var(--text-light);margin-bottom:8px;">Enter your phone number so you can call riders through the church number (your personal number stays hidden).</p>
      <div style="display:flex;gap:8px;">
        <input type="tel" id="driverPhone" placeholder="(301) 555-1234" style="flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:14px;">
        <button class="btn btn-navy" onclick="saveDriverPhone()" style="width:auto;">Save</button>
      </div>
      <div id="phoneSaved" style="display:none;margin-top:8px;font-size:12px;color:var(--green);font-weight:600;">‚úÖ Saved! Calls will come to this number.</div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-head">
      <span>üìç Controls</span>
    </div>
    <div class="panel-body" style="display:flex;flex-direction:column;gap:10px;">
      <button class="btn btn-green" id="shareBtn" onclick="toggleSharing()">üìç Start Sharing My Location</button>
      <button class="btn btn-navy" id="enrouteBtn" onclick="notifyEnRoute()">üöó Notify My Riders: En Route</button>
      <button class="btn btn-gold" id="gmapsBtn" onclick="openGoogleMaps()">üó∫Ô∏è Open Route in Google Maps</button>
      <button class="btn btn-red" id="endBtn" onclick="endMySession()" style="display:none;">üèÅ End My Session</button>
    </div>
  </div>

  <div id="map"></div>

  <div class="panel">
    <div class="panel-head">
      <span>üìã Your Stops</span>
      <span id="progress" style="font-size:12px;color:var(--text-light);">0/0 picked up</span>
    </div>
    <div class="panel-body">
      <div class="church-card"><strong>üèõÔ∏è Start:</strong> 10001 Aerospace Rd, Lanham, MD 20706</div>
      <div id="stopsList"></div>
      <div class="church-card" style="margin-top:8px;"><strong>üèõÔ∏è Return:</strong> 10001 Aerospace Rd, Lanham, MD 20706</div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

<script>
var PROXY = 'https://clickup-proxy.subscriptions-34a.workers.dev';
var CHURCH = { address: '10001 Aerospace Rd, Lanham, MD 20706', lat: 38.9847, lng: -76.8545 };

// Parse URL params
var params = new URLSearchParams(window.location.search);
var sessionId = params.get('session') || '';
var driverName = params.get('driver') || 'Driver';
var driverColor = params.get('color') || '#B8962E';
var stopsData = [];

try { stopsData = JSON.parse(decodeURIComponent(params.get('stops') || '[]')); } catch(e) {}

document.getElementById('driverBadge').textContent = 'üßë‚Äç‚úàÔ∏è ' + driverName;
document.getElementById('driverBadge').style.background = driverColor;
document.title = driverName + ' ‚Äî Route ‚Äî RCC';

var map, directionsRenderer;
var watchId = null;
var etaInterval = null;
var pickedUp = {};

var driverPhone = localStorage.getItem('rcc_driver_phone') || '';

// Pre-fill if saved
if (driverPhone) {
  document.getElementById('driverPhone').value = driverPhone;
  document.getElementById('phoneSaved').style.display = '';
}

function saveDriverPhone() {
  var phone = document.getElementById('driverPhone').value.trim();
  if (!phone) return;
  driverPhone = phone;
  localStorage.setItem('rcc_driver_phone', phone);
  document.getElementById('phoneSaved').style.display = '';
  toast('‚úÖ Phone number saved!');
}

async function callRider(riderPhone, riderName, btn) {
  if (!driverPhone) {
    toast('‚ö†Ô∏è Enter your phone number first (top of page)');
    document.getElementById('driverPhone').focus();
    document.getElementById('phonePanel').scrollIntoView({ behavior: 'smooth' });
    return;
  }

  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';

  try {
    var res = await fetch(PROXY + '/call/connect', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        driverPhone: driverPhone,
        riderPhone: riderPhone,
        riderName: riderName,
        driverName: driverName,
      }),
    });
    var data = await res.json();

    if (data.ok) {
      toast('üìû Calling... your phone will ring, then we connect you to ' + riderName);
      btn.innerHTML = 'üìû Calling...';
      setTimeout(function() { btn.disabled = false; btn.innerHTML = 'üìû Call'; }, 15000);
    } else {
      toast('‚ùå Call failed: ' + (data.error || 'Unknown error'));
      btn.disabled = false;
      btn.innerHTML = 'üìû Call';
    }
  } catch (err) {
    toast('‚ùå Call failed: ' + err.message);
    btn.disabled = false;
    btn.innerHTML = 'üìû Call';
  }
}

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg; t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 3000);
}

// ‚îÄ‚îÄ Init Map & Route ‚îÄ‚îÄ
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: { lat: CHURCH.lat, lng: CHURCH.lng }, zoom: 11,
    styles: [{ featureType:'poi', stylers:[{visibility:'off'}] }],
    disableDefaultUI: true, zoomControl: true,
  });

  if (stopsData.length === 0) {
    document.getElementById('stopsList').innerHTML = '<p style="color:var(--text-light);font-size:13px;">No stops assigned. Check the link from your admin.</p>';
    return;
  }

  // Build waypoints
  var waypoints = stopsData.map(function(s) { return { location: s.address, stopover: true }; });

  var ds = new google.maps.DirectionsService();
  ds.route({
    origin: CHURCH.address,
    destination: CHURCH.address,
    waypoints: waypoints,
    optimizeWaypoints: true,
    travelMode: google.maps.TravelMode.DRIVING,
  }, function(result, status) {
    if (status !== 'OK') {
      document.getElementById('stopsList').innerHTML = '<p style="color:var(--red);">Could not generate route. Check addresses.</p>';
      return;
    }

    directionsRenderer = new google.maps.DirectionsRenderer({
      map: map, directions: result,
      polylineOptions: { strokeColor: driverColor, strokeWeight: 4, strokeOpacity: 0.8 },
    });

    // Reorder stops by optimized order
    var order = result.routes[0].waypoint_order;
    var ordered = order.map(function(i) { return stopsData[i]; });
    stopsData = ordered;
    renderStops();
  });
}

function renderStops() {
  var html = '';
  var pickedCount = 0;
  stopsData.forEach(function(stop, i) {
    var isPicked = !!pickedUp[stop.name];
    if (isPicked) pickedCount++;
    html += '<div class="stop-card' + (isPicked ? ' picked' : '') + '" id="stop-card-' + i + '">' +
      '<div style="display:flex;align-items:center;">' +
        '<div class="stop-num" style="background:' + driverColor + ';">' + (i + 1) + '</div>' +
        '<div style="flex:1;">' +
          '<div class="stop-name">' + stop.name + (isPicked ? ' ‚úÖ' : '') + '</div>' +
          '<div class="stop-addr">' + stop.address + '</div>' +
          '<div class="stop-meta">' + (stop.passengers || 1) + ' pax' +
            (stop.phone ? ' ¬∑ üì± ' + stop.phone : '') +
            (stop.mobility && stop.mobility !== 'None' && stop.mobility !== 'No special needs' ? ' ¬∑ ‚ö†Ô∏è ' + stop.mobility : '') +
          '</div>' +
        '</div>' +
      '</div>' +
      (isPicked ? '' :
        '<div class="stop-actions">' +
          '<button class="btn-sm btn btn-green" onclick="confirmPickup(' + i + ', this)" style="width:auto;">‚úÖ Picked Up</button>' +
          '<button class="btn-sm btn btn-navy" onclick="callRider(\'' + (stop.phone || '').replace(/'/g, "\\'") + '\', \'' + stop.name.replace(/'/g, "\\'") + '\', this)" style="width:auto;' + (stop.phone ? '' : 'display:none;') + '">üìû Call</button>' +
        '</div>'
      ) +
    '</div>';
  });
  document.getElementById('stopsList').innerHTML = html;
  document.getElementById('progress').textContent = pickedCount + '/' + stopsData.length + ' picked up';

  if (pickedCount === stopsData.length && stopsData.length > 0) {
    document.getElementById('endBtn').style.display = '';
    toast('üéâ All riders picked up! Head back to church.');
  }
}

// ‚îÄ‚îÄ Picked Up ‚îÄ‚îÄ
async function confirmPickup(index, btn) {
  var stop = stopsData[index];
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span>';

  // Mark as picked up on server
  await fetch(PROXY + '/tracking/pickup-complete', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ sessionId: sessionId, riderName: stop.name }),
  });

  // Send "arrived" SMS
  if (stop.phone) {
    await fetch(PROXY + '/sms/notify-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        riders: [{ phone: stop.phone, name: stop.name }],
        status: 'arrived',
        driverName: driverName,
      }),
    });
  }

  pickedUp[stop.name] = true;
  renderStops();
  toast('‚úÖ ' + stop.name + ' picked up!');
}

// ‚îÄ‚îÄ GPS Sharing ‚îÄ‚îÄ
function toggleSharing() {
  var btn = document.getElementById('shareBtn');

  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
    if (etaInterval) clearInterval(etaInterval);
    btn.className = 'btn btn-green';
    btn.textContent = 'üìç Start Sharing My Location';
    document.getElementById('statusBar').className = 'status-bar status-off';
    document.getElementById('statusBar').textContent = 'Location sharing stopped';
    return;
  }

  if (!navigator.geolocation) { alert('Geolocation not supported.'); return; }

  btn.className = 'btn btn-red';
  btn.textContent = '‚èπ Stop Sharing Location';

  watchId = navigator.geolocation.watchPosition(
    function(pos) {
      var lat = pos.coords.latitude, lng = pos.coords.longitude;

      // Send to server with THIS driver's name
      fetch(PROXY + '/tracking/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId: sessionId, lat: lat, lng: lng, driverName: driverName }),
      });

      document.getElementById('statusBar').className = 'status-bar status-live';
      document.getElementById('statusBar').innerHTML = 'üì° <strong>Sharing Live</strong> ‚Äî ' + new Date().toLocaleTimeString();
    },
    function(err) {
      document.getElementById('statusBar').className = 'status-bar';
      document.getElementById('statusBar').style.background = '#FDE8E8';
      document.getElementById('statusBar').style.color = 'var(--red)';
      document.getElementById('statusBar').textContent = 'Location error: ' + err.message;
    },
    { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
  );

  // Check ETAs every 30 seconds
  etaInterval = setInterval(checkETAs, 30000);
}

async function checkETAs() {
  if (!stopsData.length) return;
  try {
    var pos = await new Promise(function(res, rej) {
      navigator.geolocation.getCurrentPosition(res, rej, { enableHighAccuracy: true });
    });

    var etas = [];
    var ds = new google.maps.DirectionsService();

    for (var i = 0; i < stopsData.length; i++) {
      var stop = stopsData[i];
      if (!stop.phone || pickedUp[stop.name]) continue;

      var result = await new Promise(function(resolve) {
        ds.route({
          origin: new google.maps.LatLng(pos.coords.latitude, pos.coords.longitude),
          destination: stop.address,
          travelMode: google.maps.TravelMode.DRIVING,
        }, function(r, s) { resolve(s === 'OK' ? r : null); });
      });

      if (result) {
        etas.push({
          riderName: stop.name,
          phone: stop.phone,
          address: stop.address,
          etaMinutes: Math.ceil(result.routes[0].legs[0].duration.value / 60),
          driverName: driverName,
        });
      }
    }

    if (etas.length > 0) {
      var res = await fetch(PROXY + '/tracking/check-eta', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ sessionId: sessionId, driverLat: pos.coords.latitude, driverLng: pos.coords.longitude, etas: etas }),
      });
      var data = await res.json();
      if (data.smsSent > 0) toast('üì± Tracking link sent to ' + data.smsSent + ' rider(s)');
    }
  } catch(e) { console.warn('ETA check error', e); }
}

// ‚îÄ‚îÄ En Route SMS ‚îÄ‚îÄ
async function notifyEnRoute() {
  var btn = document.getElementById('enrouteBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Sending...';

  var batch = stopsData.filter(function(s) { return s.phone && !pickedUp[s.name]; })
    .map(function(s) { return { phone: s.phone, name: s.name }; });

  if (batch.length > 0) {
    await fetch(PROXY + '/sms/notify-status', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ riders: batch, status: 'en_route', driverName: driverName }),
    });
  }

  toast('üì± En Route SMS sent to ' + batch.length + ' rider(s)!');
  btn.innerHTML = '‚úÖ Riders Notified';
}

// ‚îÄ‚îÄ Google Maps ‚îÄ‚îÄ
function openGoogleMaps() {
  var stops = [CHURCH.address];
  stopsData.forEach(function(s) { if (!pickedUp[s.name]) stops.push(s.address); });
  stops.push(CHURCH.address);
  window.open('https://www.google.com/maps/dir/' + stops.map(encodeURIComponent).join('/'), '_blank');
}

// ‚îÄ‚îÄ End Session ‚îÄ‚îÄ
async function endMySession() {
  if (!confirm('End your session? This stops sharing your location.')) return;
  if (watchId !== null) { navigator.geolocation.clearWatch(watchId); watchId = null; }
  if (etaInterval) clearInterval(etaInterval);

  // Notify server
  try {
    await fetch(PROXY + '/tracking/end-session', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ sessionId: sessionId }),
    });
  } catch(e) { console.warn('End session server call failed', e); }

  document.getElementById('shareBtn').disabled = true;
  document.getElementById('endBtn').disabled = true;
  document.getElementById('statusBar').className = 'status-bar status-off';
  document.getElementById('statusBar').textContent = 'üèÅ Session ended. Safe travels!';
  toast('üèÅ Session ended.');
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6aFSYheMeqE7NUs3zZolyxPojLQuTqg4&libraries=places,directions&callback=initMap"></script>

</body>
</html>
