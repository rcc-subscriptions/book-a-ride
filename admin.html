<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard â€” RCC Transportation</title>
<!-- VERSION: 2026-02-25-v7 -->
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --gold:#B8962E; --gold-light:#D4B44A; --gold-pale:#F5EDD4;
    --navy:#1B2040; --green:#27864A; --green-bg:#E8F5ED;
    --red:#C0392B; --border:#e0ddd0; --cream:#FDFAF3;
    --text-dark:#1B2040; --text-mid:#4A4637; --text-light:#7A7565;
    --radius:10px;
  }
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Outfit',sans-serif;background:var(--cream);color:var(--text-dark);min-height:100vh;}
  .header{background:var(--navy);color:white;padding:16px 24px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;}
  .header h1{font-size:18px;font-weight:600;}
  .header .subtitle{font-size:12px;color:rgba(255,255,255,0.6);}
  .header .date-badge{background:var(--gold);color:var(--navy);padding:6px 14px;border-radius:20px;font-size:13px;font-weight:600;}
  .container{max-width:1200px;margin:0 auto;padding:20px;}
  .panel{background:white;border-radius:var(--radius);border:1px solid var(--border);box-shadow:0 2px 8px rgba(0,0,0,0.04);margin-bottom:20px;overflow:hidden;}
  .panel-header{padding:16px 20px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
  .panel-header h2{font-size:16px;font-weight:600;}
  .panel-body{padding:20px;}
  .btn{display:inline-flex;align-items:center;gap:6px;padding:10px 18px;border:none;border-radius:var(--radius);cursor:pointer;font-family:inherit;font-size:13px;font-weight:600;transition:all 0.2s;}
  .btn-primary{background:var(--gold);color:white;} .btn-primary:hover{background:var(--gold-light);}
  .btn-navy{background:var(--navy);color:white;} .btn-navy:hover{background:#2a3060;}
  .btn-green{background:var(--green);color:white;} .btn-green:hover{background:#2ea055;}
  .btn-red{background:var(--red);color:white;} .btn-red:hover{background:#e74c3c;}
  .btn-outline{background:white;color:var(--navy);border:1.5px solid var(--border);} .btn-outline:hover{border-color:var(--gold);background:var(--gold-pale);}
  .btn:disabled{opacity:0.5;cursor:not-allowed;}
  .btn-sm{padding:6px 12px;font-size:12px;}
  .ride-card{border:1px solid var(--border);border-radius:var(--radius);padding:14px 16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;transition:all 0.2s;cursor:pointer;}
  .ride-card:hover{border-color:var(--gold);box-shadow:0 2px 8px rgba(184,150,46,0.1);}
  .ride-card.selected{border-color:var(--gold);background:var(--gold-pale);}
  .ride-card.assigned{border-left:4px solid var(--green);}
  .ride-card .ride-info{flex:1;min-width:0;}
  .ride-card .ride-name{font-weight:600;font-size:14px;}
  .ride-card .ride-addr{font-size:12px;color:var(--text-light);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
  .ride-card .ride-meta{font-size:11px;color:var(--text-light);margin-top:2px;}
  .ride-badge{font-size:10px;font-weight:600;padding:3px 8px;border-radius:10px;white-space:nowrap;}
  .badge-confirmed{background:var(--green-bg);color:var(--green);}
  .badge-submitted{background:#FFF3E0;color:#E65100;}
  .driver-row{display:flex;align-items:center;gap:12px;padding:12px 16px;background:var(--gold-pale);border-radius:var(--radius);margin-bottom:10px;}
  .driver-row .driver-name{font-weight:600;font-size:14px;flex:1;}
  .driver-row .driver-count{font-size:12px;color:var(--text-light);}
  .driver-input-row{display:flex;gap:10px;margin-bottom:16px;}
  .driver-input-row input{flex:1;padding:10px 14px;border:1.5px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:13px;outline:none;}
  .driver-input-row input:focus{border-color:var(--gold);}
  #map{width:100%;height:500px;border-radius:var(--radius);border:1px solid var(--border);}
  .route-stats{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:12px;margin-bottom:16px;}
  .stat-card{background:var(--gold-pale);border-radius:var(--radius);padding:14px 16px;text-align:center;}
  .stat-card .stat-value{font-size:24px;font-weight:700;color:var(--navy);}
  .stat-card .stat-label{font-size:11px;color:var(--text-light);margin-top:2px;}
  .tab-bar{display:flex;gap:4px;margin-bottom:-1px;position:relative;z-index:1;}
  .tab{padding:8px 16px;font-size:13px;font-weight:500;cursor:pointer;border-radius:var(--radius) var(--radius) 0 0;border:1px solid transparent;background:transparent;color:var(--text-light);transition:all 0.2s;}
  .tab.active{background:white;border-color:var(--border);border-bottom-color:white;color:var(--navy);font-weight:600;}
  .color-dot{width:14px;height:14px;border-radius:50%;flex-shrink:0;border:2px solid white;box-shadow:0 0 0 1px rgba(0,0,0,0.15);display:inline-block;vertical-align:middle;}
  .empty-state{text-align:center;padding:40px 20px;color:var(--text-light);}
  .spinner{width:20px;height:20px;border:2px solid var(--border);border-top-color:var(--gold);border-radius:50%;animation:spin 0.8s linear infinite;display:inline-block;}
  .toast{position:fixed;bottom:20px;right:20px;background:var(--navy);color:white;padding:12px 20px;border-radius:var(--radius);font-size:13px;z-index:9999;box-shadow:0 4px 16px rgba(0,0,0,0.2);transition:all 0.3s;opacity:0;transform:translateY(10px);}
  .toast.show{opacity:1;transform:translateY(0);}
  .tracking-section{margin-top:12px;padding:12px 16px;background:var(--cream);border-radius:var(--radius);font-size:13px;}
  .tracking-section a{color:var(--gold);font-weight:600;word-break:break-all;}
  @keyframes spin{to{transform:rotate(360deg);}}
  @media(max-width:768px){.container{padding:12px;}#map{height:350px;}.route-stats{grid-template-columns:1fr 1fr;}}
</style>
</head>
<body>

<!-- PASSWORD LOCK SCREEN -->
<div id="lockScreen" style="min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--navy);">
  <div style="background:white;border-radius:var(--radius);padding:40px;max-width:380px;width:90%;text-align:center;box-shadow:0 8px 32px rgba(0,0,0,0.2);">
    <div style="font-size:40px;margin-bottom:12px;">ğŸ”’</div>
    <h2 style="font-size:18px;margin-bottom:4px;color:var(--navy);">Driver Dashboard</h2>
    <p style="font-size:13px;color:var(--text-light);margin-bottom:24px;">Redeemers Church of Christ â€” Transportation</p>
    <div style="position:relative;">
      <input type="password" id="pinInput" placeholder="Enter password" maxlength="50"
        style="width:100%;padding:14px 48px 14px 14px;border:1.5px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:15px;text-align:center;outline:none;margin-bottom:12px;"
        onkeydown="if(event.key==='Enter')checkPin()"
        autofocus>
      <button type="button" onclick="togglePwdVisibility()" id="togglePwdBtn"
        style="position:absolute;right:12px;top:14px;background:none;border:none;cursor:pointer;font-size:18px;color:var(--text-light);padding:0;line-height:1;"
        title="Show password">ğŸ‘ï¸</button>
    </div>
    <div id="pinError" style="font-size:12px;color:var(--red);margin-bottom:12px;display:none;">Incorrect password. Please try again.</div>
    <button class="btn btn-primary" onclick="checkPin()" style="width:100%;justify-content:center;padding:14px;font-size:15px;">Unlock Dashboard</button>
    <p style="font-size:11px;color:var(--text-light);margin-top:16px;">Contact the IT Division if you need the access PIN.</p>
  </div>
</div>

<!-- MAIN DASHBOARD (hidden until PIN entered) -->
<div id="mainDashboard" style="display:none;">

<div class="header">
  <div>
    <h1>ğŸš Driver Dashboard</h1>
    <div class="subtitle">Redeemers Church of Christ â€” Transportation Department</div>
  </div>
  <div class="date-badge" id="sundayDate"></div>
</div>

<div class="container">

  <!-- STEP 1: LOAD RIDES -->
  <div class="panel" id="ridesPanel">
    <div class="panel-header">
      <h2>ğŸ“‹ Sunday Ride Requests</h2>
      <div style="display:flex;gap:8px;align-items:center;">
        <span id="rideCount" style="font-size:12px;color:var(--text-light);"></span>
        <button class="btn btn-primary" id="loadRidesBtn" onclick="loadRides()">Load This Sunday's Rides</button>
      </div>
    </div>
    <div class="panel-body" id="ridesBody">
      <div class="empty-state">
        <p>Click <strong>"Load This Sunday's Rides"</strong> to fetch ride requests from ClickUp.</p>
      </div>
    </div>
  </div>

  <!-- STEP 2: DRIVERS -->
  <div class="panel" id="driversPanel" style="display:none;">
    <div class="panel-header"><h2>ğŸ§‘â€âœˆï¸ Drivers</h2></div>
    <div class="panel-body">
      <div class="driver-input-row">
        <input type="text" id="driverNameInput" placeholder="Enter driver name..." onkeydown="if(event.key==='Enter')addDriver()">
        <button class="btn btn-navy" onclick="addDriver()">+ Add Driver</button>
      </div>
      <div id="driversList"></div>
      <p style="font-size:12px;color:var(--text-light);margin-top:8px;">Add all drivers, then assign rides below.</p>
    </div>
  </div>

  <!-- STEP 3: ASSIGN -->
  <div class="panel" id="assignPanel" style="display:none;">
    <div class="panel-header">
      <h2>ğŸ“ Assign Rides to Drivers</h2>
      <button class="btn btn-green" id="generateRouteBtn" onclick="generateRoutes()" disabled>Generate Routes & Notify Riders</button>
    </div>
    <div class="panel-body">
      <p style="font-size:13px;color:var(--text-light);margin-bottom:16px;">Click a ride, then click a driver to assign.</p>
      <div id="assignableRides"></div>
    </div>
  </div>

  <!-- STEP 4: ROUTES & MAP -->
  <div class="panel" id="routePanel" style="display:none;">
    <div class="panel-header">
      <h2>ğŸ—ºï¸ Route Plan</h2>
      <button class="btn btn-outline btn-sm" onclick="openAllInGoogleMaps()">Open in Google Maps</button>
    </div>
    <div class="panel-body">
      <div class="route-stats" id="routeStats"></div>
      <div class="tab-bar" id="routeTabs"></div>
      <div id="map"></div>
      <div id="routeDetails" style="margin-top:16px;"></div>
    </div>
  </div>

  <!-- STEP 5: DRIVER LINKS -->
  <div class="panel" id="trackingPanel" style="display:none;">
    <div style="background:var(--gold);color:white;padding:16px 20px;font-size:16px;font-weight:700;text-align:center;">
      ğŸ“± SEND THESE LINKS TO YOUR DRIVERS
    </div>
    <div class="panel-body">
      <p style="font-size:13px;color:var(--text-light);margin-bottom:14px;">Each driver opens their link on their phone to see their route, share GPS, and mark pickups.</p>
      <div id="driverLinksContainer"><p style="color:var(--text-light);">Generating links...</p></div>
    </div>
  </div>

</div>

<div class="toast" id="toast"></div>

</div><!-- end mainDashboard -->

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PIN PROTECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// The PIN is stored as a SHA-256 hash so it's not visible in source code.
// Default PIN: "RCC2026" â€” change by updating the hash below.
// To generate a new hash, run in browser console:
//   crypto.subtle.digest('SHA-256', new TextEncoder().encode('YOUR_NEW_PIN')).then(b => console.log(Array.from(new Uint8Array(b)).map(x => x.toString(16).padStart(2,'0')).join('')))

var PIN_HASH = '1a8dfb37bd160e058648cee3b48eeb75493d487d38411eed2d77bfab2fb8653b'; // SHA-256 of password

function togglePwdVisibility() {
  var input = document.getElementById('pinInput');
  var btn = document.getElementById('togglePwdBtn');
  if (input.type === 'password') {
    input.type = 'text';
    btn.textContent = 'ğŸ™ˆ';
    btn.title = 'Hide password';
  } else {
    input.type = 'password';
    btn.textContent = 'ğŸ‘ï¸';
    btn.title = 'Show password';
  }
  input.focus();
}

async function hashPin(pin) {
  var encoded = new TextEncoder().encode(pin);
  var buffer = await crypto.subtle.digest('SHA-256', encoded);
  return Array.from(new Uint8Array(buffer)).map(function(b) { return b.toString(16).padStart(2, '0'); }).join('');
}

async function checkPin() {
  var input = document.getElementById('pinInput');
  var pin = input.value.trim();
  if (!pin) return;

  var hash = await hashPin(pin);

  if (hash === PIN_HASH) {
    // Correct â€” save session so they don't have to re-enter on refresh
    sessionStorage.setItem('rcc_driver_auth', 'true');
    showDashboard();
  } else {
    document.getElementById('pinError').style.display = '';
    input.value = '';
    input.focus();
    input.style.borderColor = 'var(--red)';
    setTimeout(function() { input.style.borderColor = 'var(--border)'; }, 1500);
  }
}

function showDashboard() {
  document.getElementById('lockScreen').style.display = 'none';
  document.getElementById('mainDashboard').style.display = '';
}

// Check if already authenticated this session
if (sessionStorage.getItem('rcc_driver_auth') === 'true') {
  showDashboard();
}
</script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var CONFIG = {
  PROXY: 'https://clickup-proxy.subscriptions-34a.workers.dev',
  CHURCH_ADDRESS: '10001 Aerospace Rd, Lanham, MD 20706',
  CHURCH_LAT: 38.9847,
  CHURCH_LNG: -76.8545,
};

var DRIVER_COLORS = ['#E53935','#1E88E5','#43A047','#FB8C00','#8E24AA','#00ACC1','#D81B60','#6D4C41'];

var rides = [];
var drivers = [];
var assignments = {};
var selectedRideIndex = null;
var map = null;
var directionsRenderers = [];
var trackingSessionId = null;
var allRouteData = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getThisSunday() {
  var now = new Date();
  var day = now.getDay();
  var sunday = new Date(now);
  if (day !== 0) sunday.setDate(now.getDate() + (7 - day));
  return sunday.toISOString().split('T')[0];
}
var sundayStr = getThisSunday();
document.getElementById('sundayDate').textContent = new Date(sundayStr + 'T12:00:00').toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric', year:'numeric' });

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function toast(msg) {
  var t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(function() { t.classList.remove('show'); }, 3000);
}

async function apiFetch(path, opts) {
  opts = opts || {};
  var res = await fetch(CONFIG.PROXY + path, {
    method: opts.method || 'GET',
    headers: { 'Content-Type': 'application/json' },
    body: opts.body ? JSON.stringify(opts.body) : undefined,
  });
  var text = await res.text();
  try {
    return JSON.parse(text);
  } catch (e) {
    throw new Error('API returned invalid JSON (status ' + res.status + '): ' + text.substring(0, 200));
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 1: LOAD RIDES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadRides() {
  var btn = document.getElementById('loadRidesBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Loading...';

  try {
    // Step 1: Check if worker is reachable
    var testRes = await fetch(CONFIG.PROXY + '/');
    if (!testRes.ok) throw new Error('Worker not reachable (status ' + testRes.status + ')');

    // Step 2: Get list ID
    var listId = localStorage.getItem('bookARide_listId');
    if (!listId) {
      // Try to find it from ClickUp
      try {
        var teams = await apiFetch('/team');
        if (teams.teams && teams.teams.length > 0) {
          var teamId = teams.teams[0].id;
          var spaces = await apiFetch('/team/' + teamId + '/space?archived=false');
          for (var si = 0; si < (spaces.spaces || []).length; si++) {
            var sp = spaces.spaces[si];
            if (sp.name && sp.name.toLowerCase().indexOf('transport') !== -1) {
              var folders = await apiFetch('/space/' + sp.id + '/folder?archived=false');
              for (var fi = 0; fi < (folders.folders || []).length; fi++) {
                var folder = folders.folders[fi];
                for (var li = 0; li < (folder.lists || []).length; li++) {
                  var list = folder.lists[li];
                  if (list.name && list.name.toLowerCase().indexOf('ride') !== -1) {
                    listId = list.id;
                    localStorage.setItem('bookARide_listId', listId);
                    toast('âœ… Found ClickUp list: ' + list.name);
                    break;
                  }
                }
                if (listId) break;
              }
            }
            if (listId) break;
          }
        }
      } catch (e) {
        console.warn('Auto-find failed:', e);
      }
    }

    if (!listId) {
      document.getElementById('ridesBody').innerHTML = '<div class="empty-state">' +
        '<p style="color:var(--red);margin-bottom:12px;font-weight:600;">ClickUp List ID not found</p>' +
        '<p style="font-size:13px;margin-bottom:12px;">Go to ClickUp â†’ open your Ride Requests list â†’ copy the list ID from the URL, then paste below:</p>' +
        '<div style="display:flex;gap:8px;">' +
          '<input type="text" id="manualListId" placeholder="e.g. 901234567890" style="flex:1;padding:10px;border:1px solid var(--border);border-radius:var(--radius);font-family:inherit;font-size:14px;">' +
          '<button class="btn btn-primary" onclick="saveListIdAndLoad()">Save & Load</button>' +
        '</div>' +
        '<p style="font-size:11px;color:var(--text-light);margin-top:8px;">Or open the booking form (bookaride.redeemerschapel.org) on this device first â€” it saves the ID automatically.</p>' +
      '</div>';
      return;
    }

    // Step 3: Fetch tasks
    document.getElementById('ridesBody').innerHTML = '<div style="text-align:center;padding:20px;"><span class="spinner"></span><br><span style="font-size:12px;color:var(--text-light);">Fetching from ClickUp... (List: ' + listId + ')</span></div>';

    var sundayStart = new Date(sundayStr + 'T00:00:00').getTime();
    var sundayEnd = new Date(sundayStr + 'T23:59:59').getTime();

    var allTasks = [];
    var page = 0;
    var hasMore = true;
    while (hasMore && page < 5) {
      var data = await apiFetch('/list/' + listId + '/task?due_date_gt=' + sundayStart + '&due_date_lt=' + sundayEnd + '&include_closed=false&page=' + page);
      if (data.err) throw new Error('ClickUp error: ' + data.err);
      var tasks = data.tasks || [];
      allTasks = allTasks.concat(tasks);
      hasMore = tasks.length === 100;
      page++;
    }

    rides = allTasks.filter(function(t) {
      var s = t.status && t.status.status ? t.status.status.toLowerCase() : '';
      return s !== 'cancelled' && s !== 'completed';
    });

    if (rides.length === 0) {
      document.getElementById('ridesBody').innerHTML = '<div class="empty-state">' +
        '<p>No rides found for <strong>' + sundayStr + '</strong></p>' +
        '<p style="font-size:12px;color:var(--text-light);margin-top:8px;">Total tasks in ClickUp: ' + allTasks.length + ' (filtered out cancelled/completed)</p>' +
        '<p style="font-size:12px;color:var(--text-light);margin-top:4px;">List ID: ' + listId + '</p>' +
        '<p style="font-size:12px;margin-top:8px;"><a href="#" onclick="localStorage.removeItem(\'bookARide_listId\');loadRides();return false;" style="color:var(--gold);">Try a different list ID</a></p>' +
      '</div>';
      return;
    }

    document.getElementById('rideCount').textContent = rides.length + ' ride' + (rides.length !== 1 ? 's' : '');
    renderRidesList();
    document.getElementById('driversPanel').style.display = '';
    document.getElementById('assignPanel').style.display = '';
    toast('âœ… Loaded ' + rides.length + ' rides for ' + sundayStr);
  } catch (err) {
    document.getElementById('ridesBody').innerHTML = '<div class="empty-state">' +
      '<p style="color:var(--red);font-weight:600;">Error loading rides</p>' +
      '<p style="font-size:13px;margin-top:8px;word-break:break-word;">' + err.message + '</p>' +
      '<div style="font-size:12px;color:var(--text-light);margin-top:12px;padding:10px;background:var(--cream);border-radius:var(--radius);">' +
        '<strong>Troubleshooting:</strong><br>' +
        '1. Is the Worker deployed? Visit <a href="' + CONFIG.PROXY + '/" target="_blank">' + CONFIG.PROXY + '</a><br>' +
        '2. Is the ClickUp API token valid? Check Worker secrets<br>' +
        '3. Is the list ID correct? <a href="#" onclick="localStorage.removeItem(\'bookARide_listId\');loadRides();return false;">Reset list ID</a>' +
      '</div>' +
    '</div>';
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Reload Rides';
  }
}

function saveListIdAndLoad() {
  var id = document.getElementById('manualListId').value.trim();
  if (!id) return;
  localStorage.setItem('bookARide_listId', id);
  toast('âœ… List ID saved!');
  loadRides();
}

function parseRide(task) {
  var d = { name:'', address:'', phone:'', email:'', passengers:1, mobility:'None', taskId:task.id, taskUrl:task.url };
  var m = task.name.match(/[ğŸ”„ğŸš—]\s*(.+?)\s*[â€”â€“-]\s*/);
  d.name = m ? m[1].trim() : task.name;
  d.isRecurring = (task.tags || []).some(function(t) { return t.name === 'recurring'; });
  d.status = task.status && task.status.status ? task.status.status : 'Unknown';

  (task.custom_fields || []).forEach(function(f) {
    var n = (f.name || '').toLowerCase();
    var v = f.value || '';
    if (n.indexOf('email') !== -1 && typeof v === 'string') d.email = v;
    if (n.indexOf('phone') !== -1 && typeof v === 'string') d.phone = v;
    if (n.indexOf('pickup') !== -1 && n.indexOf('address') !== -1 && typeof v === 'string') d.address = v;
    if (n.indexOf('passenger') !== -1) d.passengers = parseInt(v) || 1;
    if (n.indexOf('mobility') !== -1 && f.type_config && f.type_config.options) {
      var opt = f.type_config.options[parseInt(v)];
      if (opt) d.mobility = opt.name;
    }
  });

  if (!d.address && task.description) {
    var am = task.description.match(/Pickup Address:\*?\*?\s*(.+)/i);
    if (am) d.address = am[1].trim();
  }
  if (!d.phone && task.description) {
    var pm = task.description.match(/Phone:\*?\*?\s*(.+)/i);
    if (pm) d.phone = pm[1].trim();
  }
  if (!d.email && task.description) {
    var em = task.description.match(/Email:\*?\*?\s*(.+)/i);
    if (em) d.email = em[1].trim();
  }
  return d;
}

function renderRidesList() {
  var html = '';
  rides.forEach(function(task, i) {
    var d = parseRide(task);
    html += '<div class="ride-card" id="ride-' + i + '">' +
      '<div style="width:36px;height:36px;border-radius:50%;background:var(--gold-pale);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;">ğŸ§‘</div>' +
      '<div class="ride-info">' +
        '<div class="ride-name">' + d.name + (d.isRecurring ? ' ğŸ”„' : '') + '</div>' +
        '<div class="ride-addr">' + (d.address || 'Address not found') + '</div>' +
        '<div class="ride-meta">' + d.passengers + ' pax Â· ' + d.mobility + (d.phone ? ' Â· ' + d.phone : '') + '</div>' +
      '</div>' +
      '<span class="ride-badge badge-submitted">' + d.status + '</span>' +
    '</div>';
  });
  document.getElementById('ridesBody').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 2: DRIVERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function addDriver() {
  var input = document.getElementById('driverNameInput');
  var name = input.value.trim();
  if (!name) return;
  drivers.push({ name:name, color:DRIVER_COLORS[drivers.length % DRIVER_COLORS.length] });
  assignments[drivers.length - 1] = [];
  input.value = '';
  renderDrivers();
  renderAssignableRides();
}

function removeDriver(idx) {
  delete assignments[idx];
  drivers.splice(idx, 1);
  var newA = {};
  var di = 0;
  Object.keys(assignments).sort().forEach(function(k) { newA[di] = assignments[k]; di++; });
  assignments = newA;
  renderDrivers();
  renderAssignableRides();
}

function renderDrivers() {
  var html = '';
  drivers.forEach(function(d, i) {
    var count = (assignments[i] || []).length;
    html += '<div class="driver-row">' +
      '<span class="color-dot" style="background:' + d.color + ';"></span>' +
      '<div class="driver-name">' + d.name + '</div>' +
      '<div class="driver-count">' + count + ' ride' + (count !== 1 ? 's' : '') + '</div>' +
      '<button class="btn btn-outline btn-sm" onclick="removeDriver(' + i + ')">âœ•</button>' +
    '</div>';
  });
  document.getElementById('driversList').innerHTML = html || '<p style="font-size:13px;color:var(--text-light);">No drivers added yet.</p>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 3: ASSIGN
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function selectRide(i) {
  if (drivers.length === 0) { alert('Add at least one driver first.'); return; }
  selectedRideIndex = (selectedRideIndex === i) ? null : i;
  renderAssignableRides();
}

function assignRide(ri, di) {
  for (var k in assignments) assignments[k] = assignments[k].filter(function(r) { return r !== ri; });
  assignments[di] = assignments[di] || [];
  assignments[di].push(ri);
  selectedRideIndex = null;
  renderDrivers();
  renderAssignableRides();
  checkAllAssigned();
}

function unassignRide(ri) {
  for (var k in assignments) assignments[k] = assignments[k].filter(function(r) { return r !== ri; });
  renderDrivers();
  renderAssignableRides();
  checkAllAssigned();
}

function getDriverFor(ri) {
  for (var k in assignments) { if (assignments[k].indexOf(ri) !== -1) return parseInt(k); }
  return -1;
}

function checkAllAssigned() {
  var all = true;
  for (var i = 0; i < rides.length; i++) { if (getDriverFor(i) === -1) { all = false; break; } }
  document.getElementById('generateRouteBtn').disabled = !all || drivers.length === 0;
}

function renderAssignableRides() {
  var html = '';
  rides.forEach(function(task, i) {
    var d = parseRide(task);
    var di = getDriverFor(i);
    var isA = di !== -1;
    var col = isA ? drivers[di].color : '';
    var dn = isA ? drivers[di].name : '';

    html += '<div class="ride-card' + (isA ? ' assigned' : '') + (selectedRideIndex === i ? ' selected' : '') + '" ' +
      'style="' + (isA ? 'border-left-color:' + col + ';' : '') + '" onclick="selectRide(' + i + ')">' +
      (isA ? '<span class="color-dot" style="background:' + col + ';"></span>' : '') +
      '<div class="ride-info">' +
        '<div class="ride-name">' + d.name + '</div>' +
        '<div class="ride-addr">' + (d.address || 'No address') + '</div>' +
        (isA ? '<div class="ride-meta" style="color:' + col + ';font-weight:500;">â†’ ' + dn + ' <a href="#" onclick="event.stopPropagation();unassignRide(' + i + ')" style="color:var(--red);font-size:11px;">(remove)</a></div>' : '') +
      '</div></div>';

    if (selectedRideIndex === i) {
      html += '<div style="display:flex;gap:8px;margin:-6px 0 10px 28px;flex-wrap:wrap;">';
      drivers.forEach(function(dr, dri) {
        html += '<button class="btn btn-sm" style="background:' + dr.color + ';color:white;" onclick="event.stopPropagation();assignRide(' + i + ',' + dri + ')">' + dr.name + '</button>';
      });
      html += '</div>';
    }
  });
  document.getElementById('assignableRides').innerHTML = html;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 4: GENERATE ROUTES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function generateRoutes() {
  var btn = document.getElementById('generateRouteBtn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner"></span> Generating routes & sending SMS...';

  document.getElementById('routePanel').style.display = '';
  document.getElementById('trackingPanel').style.display = '';

  if (!map) {
    map = new google.maps.Map(document.getElementById('map'), {
      center: { lat:CONFIG.CHURCH_LAT, lng:CONFIG.CHURCH_LNG },
      zoom: 11,
      styles: [{ featureType:'poi', stylers:[{visibility:'off'}] }],
    });
  }

  directionsRenderers.forEach(function(r) { r.setMap(null); });
  directionsRenderers = [];
  allRouteData = [];

  // Generate session ID for tracking
  trackingSessionId = 'rcc_' + sundayStr.replace(/-/g, '') + '_' + Math.random().toString(36).substr(2, 6);
  // Store for Command Center to find
  localStorage.setItem('rcc_active_session', trackingSessionId);

  var directionsService = new google.maps.DirectionsService();
  var statsHtml = '';
  var tabsHtml = '';
  var detailsHtml = '';
  var allRiderInfo = []; // For creating tracking session

  for (var di = 0; di < drivers.length; di++) {
    var driverRides = assignments[di] || [];
    if (driverRides.length === 0) continue;
    var driver = drivers[di];
    var waypoints = [];
    var stopDetails = [];

    for (var ri = 0; ri < driverRides.length; ri++) {
      var rd = parseRide(rides[driverRides[ri]]);
      if (rd.address) {
        waypoints.push({ location: rd.address, stopover: true });
        stopDetails.push(rd);
      }
    }
    if (waypoints.length === 0) continue;

    var routeResult = await new Promise(function(resolve) {
      directionsService.route({
        origin: CONFIG.CHURCH_ADDRESS,
        destination: CONFIG.CHURCH_ADDRESS,
        waypoints: waypoints,
        optimizeWaypoints: true,
        travelMode: google.maps.TravelMode.DRIVING,
      }, function(result, status) { resolve(status === 'OK' ? result : null); });
    });

    if (!routeResult) {
      detailsHtml += '<p style="color:var(--red);">Could not generate route for ' + driver.name + '</p>';
      continue;
    }

    var renderer = new google.maps.DirectionsRenderer({
      map: map, directions: routeResult,
      polylineOptions: { strokeColor: driver.color, strokeWeight: 4, strokeOpacity: 0.8 },
      suppressMarkers: false,
    });
    directionsRenderers.push(renderer);

    var route = routeResult.routes[0];
    var totalDist = 0, totalTime = 0;
    route.legs.forEach(function(leg) { totalDist += leg.distance.value; totalTime += leg.duration.value; });

    var orderedStops = route.waypoint_order.map(function(idx) { return stopDetails[idx]; });

    var routeDataItem = {
      driver: driver, driverIndex: di, route: routeResult,
      stops: orderedStops,
      totalMiles: (totalDist / 1609.34).toFixed(1),
      totalMinutes: Math.ceil(totalTime / 60),
    };
    allRouteData.push(routeDataItem);

    // Collect rider info for tracking session
    orderedStops.forEach(function(s) {
      allRiderInfo.push({ name: s.name, phone: s.phone, address: s.address, taskId: s.taskId, driverName: driver.name });
    });

    statsHtml += '<div class="stat-card">' +
      '<span class="color-dot" style="background:' + driver.color + ';margin-bottom:6px;"></span>' +
      '<div class="stat-value">' + orderedStops.length + '</div>' +
      '<div class="stat-label">' + driver.name + '</div>' +
      '<div style="font-size:11px;color:var(--text-light);margin-top:4px;">' + routeDataItem.totalMiles + ' mi Â· ' + routeDataItem.totalMinutes + ' min</div>' +
    '</div>';

    tabsHtml += '<div class="tab' + (allRouteData.length === 1 ? ' active' : '') + '" onclick="showDriverRoute(' + (allRouteData.length - 1) + ')" data-idx="' + (allRouteData.length - 1) + '">' +
      '<span class="color-dot" style="background:' + driver.color + ';width:10px;height:10px;margin-right:4px;"></span>' + driver.name + '</div>';

    detailsHtml += '<div class="driver-route-detail" data-idx="' + (allRouteData.length - 1) + '" style="' + (allRouteData.length > 1 ? 'display:none;' : '') + '">';
    detailsHtml += '<div style="padding:10px 14px;background:var(--green-bg);border-radius:var(--radius);font-size:13px;margin-bottom:8px;"><strong>ğŸ›ï¸ Start:</strong> ' + CONFIG.CHURCH_ADDRESS + '</div>';

    orderedStops.forEach(function(stop, si) {
      detailsHtml += '<div style="padding:10px 14px;border-left:3px solid ' + driver.color + ';margin-left:6px;margin-bottom:6px;background:white;border-radius:0 var(--radius) var(--radius) 0;">' +
        '<div style="font-weight:600;font-size:13px;">Stop ' + (si + 1) + ': ' + stop.name + '</div>' +
        '<div style="font-size:12px;color:var(--text-light);">' + stop.address + '</div>' +
        '<div style="font-size:11px;color:var(--text-light);margin-top:2px;">' + stop.passengers + ' pax' +
        (stop.mobility !== 'No special needs' && stop.mobility !== 'None' ? ' Â· âš ï¸ ' + stop.mobility : '') +
        (stop.phone ? ' Â· ğŸ“± ' + stop.phone : '') + '</div>' +
      '</div>';
    });

    detailsHtml += '<div style="padding:10px 14px;background:var(--green-bg);border-radius:var(--radius);font-size:13px;margin-top:8px;"><strong>ğŸ›ï¸ Return:</strong> ' + CONFIG.CHURCH_ADDRESS + '</div>';

    // Driver link inline - right in the route details
    detailsHtml += '<div style="margin-top:12px;padding:14px;background:var(--gold-pale);border:2px solid var(--gold);border-radius:var(--radius);">' +
      '<div style="font-weight:700;font-size:14px;color:var(--navy);margin-bottom:8px;">ğŸ“± Send Route to ' + driver.name + '</div>' +
      '<div style="display:flex;gap:8px;flex-wrap:wrap;" id="driver-link-area-' + di + '"></div>' +
      '<input type="hidden" class="driver-link-data" data-driver-index="' + di + '" data-driver-name="' + driver.name.replace(/"/g, '&quot;') + '" data-driver-color="' + driver.color + '">' +
    '</div>';

    detailsHtml += '</div>';
  }

  var totalRides = rides.length;
  statsHtml = '<div class="stat-card"><div class="stat-value">' + totalRides + '</div><div class="stat-label">Total Pickups</div></div>' +
    '<div class="stat-card"><div class="stat-value">' + drivers.length + '</div><div class="stat-label">Drivers</div></div>' + statsHtml;

  document.getElementById('routeStats').innerHTML = statsHtml;
  document.getElementById('routeTabs').innerHTML = tabsHtml;
  document.getElementById('routeDetails').innerHTML = detailsHtml;

  // Show driver links immediately
  try {
    generateDriverLinks();
  } catch (linkErr) {
    console.error('Link generation failed:', linkErr);
    document.getElementById('driverLinksContainer').innerHTML =
      '<div style="padding:14px;color:var(--red);background:#fde8e8;border-radius:10px;">' +
      '<strong>Error:</strong> ' + linkErr.message + '</div>';
  }
  document.getElementById('trackingPanel').style.display = '';
  btn.disabled = false;
  btn.innerHTML = 'âœ… Routes Generated! Send links below â†“';
  document.getElementById('trackingPanel').scrollIntoView({ behavior: 'smooth' });

  // Fire-and-forget server updates (don't block the page)
  doServerUpdates(allRiderInfo);
}

async function doServerUpdates(allRiderInfo) {
  try {
    var driverInfo = allRouteData.map(function(rd) {
      return {
        name: rd.driver.name, color: rd.driver.color,
        stopCount: rd.stops.length, totalMiles: rd.totalMiles, totalMinutes: rd.totalMinutes,
        stops: rd.stops.map(function(s) { return { name: s.name, address: s.address }; }),
      };
    });
    await apiFetch('/tracking/session', {
      method: 'POST',
      body: { sessionId: trackingSessionId, riders: allRiderInfo, drivers: driverInfo },
    });
    await updateClickUpAndNotify(allRouteData);
    toast('âœ… Riders notified! Now send driver links.');
  } catch (err) {
    console.warn('Server updates failed:', err);
    toast('âš ï¸ Routes ready! Server sync may have failed.');
  }
}

function buildDriverLink(routeData) {
  var base = window.location.href.replace('driver.html', 'drive.html');
  var stopsParam = routeData.stops.map(function(s) {
    return { name: s.name, address: s.address, phone: s.phone || '', passengers: s.passengers || 1, mobility: s.mobility || 'None', taskId: s.taskId || '' };
  });
  return base + '?session=' + encodeURIComponent(trackingSessionId) +
    '&driver=' + encodeURIComponent(routeData.driver.name) +
    '&color=' + encodeURIComponent(routeData.driver.color) +
    '&stops=' + encodeURIComponent(JSON.stringify(stopsParam));
}

function generateDriverLinks() {
  if (allRouteData.length === 0) {
    document.getElementById('driverLinksContainer').innerHTML = '<p style="color:var(--red);">No routes generated.</p>';
    return;
  }

  var panelHtml = '';

  allRouteData.forEach(function(rd, i) {
    var link = buildDriverLink(rd);
    var msgText = 'RCC Transportation â€” ' + rd.driver.name + ', here is your pickup route for this Sunday (' + rd.stops.length + ' stops):\n\n' + link;
    var whatsappUrl = 'https://wa.me/?text=' + encodeURIComponent(msgText);
    var smsUrl = 'sms:?&body=' + encodeURIComponent(msgText);

    var buttonsHtml =
      '<button onclick="copyLink(' + i + ')" style="padding:10px 14px;background:#B8962E;color:white;border:none;border-radius:8px;font-family:inherit;font-weight:600;font-size:13px;cursor:pointer;flex:1;min-width:120px;">ğŸ“‹ Copy Link</button>' +
      '<a href="' + whatsappUrl + '" target="_blank" style="padding:10px 14px;background:#27864A;color:white;border:none;border-radius:8px;font-family:inherit;font-weight:600;font-size:13px;cursor:pointer;text-decoration:none;text-align:center;flex:1;min-width:120px;display:inline-block;">ğŸ’¬ WhatsApp</a>' +
      '<a href="' + smsUrl + '" style="padding:10px 14px;background:#1B2040;color:white;border:none;border-radius:8px;font-family:inherit;font-weight:600;font-size:13px;cursor:pointer;text-decoration:none;text-align:center;flex:1;min-width:120px;display:inline-block;">ğŸ“± Text</a>' +
      '<input type="hidden" id="dlink-' + i + '" value="' + link.replace(/"/g, '&quot;') + '">';

    // Populate inline area in route details
    var inlineArea = document.getElementById('driver-link-area-' + rd.driverIndex);
    if (inlineArea) {
      inlineArea.innerHTML = buttonsHtml;
    }

    // Also build panel version
    var stopNames = rd.stops.map(function(s, si) { return (si + 1) + '. ' + s.name; }).join('<br>');
    panelHtml += '<div style="padding:16px;border:2px solid #e0ddd0;border-left:5px solid ' + rd.driver.color + ';border-radius:10px;margin-bottom:14px;background:white;">' +
      '<div style="display:flex;align-items:center;gap:10px;margin-bottom:6px;">' +
        '<div style="width:14px;height:14px;border-radius:50%;background:' + rd.driver.color + ';flex-shrink:0;"></div>' +
        '<strong style="font-size:15px;">' + rd.driver.name + '</strong>' +
        '<span style="font-size:12px;color:#7A7565;margin-left:auto;">' + rd.stops.length + ' stops Â· ' + rd.totalMiles + ' mi</span>' +
      '</div>' +
      '<div style="font-size:12px;color:#7A7565;padding:8px;background:#FDFAF3;border-radius:6px;margin-bottom:10px;line-height:1.6;">' + stopNames + '</div>' +
      '<div style="display:flex;gap:8px;flex-wrap:wrap;">' + buttonsHtml + '</div>' +
    '</div>';
  });

  document.getElementById('driverLinksContainer').innerHTML = panelHtml;
}

function copyLink(index) {
  var input = document.getElementById('dlink-' + index);
  if (input) {
    navigator.clipboard.writeText(input.value).then(function() {
      toast('ğŸ“‹ Link copied! Send it to your driver.');
    }).catch(function() {
      // Fallback for older browsers
      prompt('Copy this link:', input.value);
    });
  }
}

function showDriverRoute(idx) {
  document.querySelectorAll('.tab').forEach(function(t) { t.classList.toggle('active', t.getAttribute('data-idx') == idx); });
  document.querySelectorAll('.driver-route-detail').forEach(function(d) { d.style.display = d.getAttribute('data-idx') == idx ? '' : 'none'; });
  if (directionsRenderers[idx]) {
    map.fitBounds(directionsRenderers[idx].getDirections().routes[0].bounds);
  }
}

function openAllInGoogleMaps() {
  allRouteData.forEach(function(rd) {
    var stops = [CONFIG.CHURCH_ADDRESS];
    rd.stops.forEach(function(s) { stops.push(s.address); });
    stops.push(CONFIG.CHURCH_ADDRESS);
    window.open('https://www.google.com/maps/dir/' + stops.map(encodeURIComponent).join('/'), '_blank');
  });
}

function copyText(text) {
  navigator.clipboard.writeText(text).then(function() { toast('ğŸ“‹ Link copied!'); });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CLICKUP + SMS NOTIFICATIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function updateClickUpAndNotify(routeData) {
  var ridersToNotify = [];

  for (var ri = 0; ri < routeData.length; ri++) {
    var rd = routeData[ri];
    for (var si = 0; si < rd.stops.length; si++) {
      var stop = rd.stops[si];
      if (!stop.taskId) continue;

      // Update ClickUp task
      try {
        await apiFetch('/task/' + stop.taskId, {
          method: 'PUT',
          body: { status: 'Driver Assigned' },
        });
        await apiFetch('/task/' + stop.taskId + '/comment', {
          method: 'POST',
          body: {
            comment_text: 'ğŸš Driver: ' + rd.driver.name + ' | Stop ' + (si + 1) + '/' + rd.stops.length + ' | Route: ' + rd.totalMiles + ' mi, ~' + rd.totalMinutes + ' min',
            notify_all: false,
          },
        });
      } catch (e) { console.warn('ClickUp update failed', e); }

      if (stop.phone) {
        ridersToNotify.push({ phone: stop.phone, name: stop.name });
      }
    }
  }

  // Send "Driver Assigned" SMS to all riders
  if (ridersToNotify.length > 0) {
    for (var ri2 = 0; ri2 < routeData.length; ri2++) {
      var rd2 = routeData[ri2];
      var riderBatch = rd2.stops.filter(function(s) { return s.phone; }).map(function(s) { return { phone: s.phone, name: s.name }; });
      if (riderBatch.length > 0) {
        await apiFetch('/sms/notify-status', {
          method: 'POST',
          body: { riders: riderBatch, status: 'driver_assigned', driverName: rd2.driver.name },
        });
      }
    }
  }
}
</script>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6aFSYheMeqE7NUs3zZolyxPojLQuTqg4&libraries=places,directions&callback=Function.prototype"></script>

</body>
</html>
