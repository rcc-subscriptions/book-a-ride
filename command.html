<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Command Center ‚Äî RCC Transportation</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root{--gold:#B8962E;--gold-light:#D4B44A;--navy:#1B2040;--green:#27864A;--red:#C0392B;--radius:10px;}
  *{margin:0;padding:0;box-sizing:border-box;}
  body{font-family:'Outfit',sans-serif;background:#0d1117;color:white;min-height:100vh;overflow:hidden;}

  .header{background:var(--navy);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,0.1);}
  .header h1{font-size:16px;font-weight:600;}
  .header .sub{font-size:11px;color:rgba(255,255,255,0.5);}
  .hdr-right{display:flex;align-items:center;gap:12px;}
  .live-dot{width:8px;height:8px;border-radius:50%;display:inline-block;margin-right:4px;}
  .live-badge{font-size:10px;font-weight:700;padding:4px 10px;border-radius:12px;display:flex;align-items:center;gap:4px;}
  .badge-live{background:#E53935;color:white;animation:pulse-red 2s infinite;}
  .badge-wait{background:#444;color:#aaa;}
  .badge-off{background:#333;color:#666;}
  @keyframes pulse-red{0%,100%{box-shadow:0 0 0 0 rgba(229,57,53,0.4);}50%{box-shadow:0 0 0 8px rgba(229,57,53,0);}}
  .clock{font-size:14px;font-weight:600;color:var(--gold);}

  .layout{display:flex;height:calc(100vh - 52px);}
  .sidebar{width:340px;background:#161b22;border-right:1px solid rgba(255,255,255,0.08);overflow-y:auto;flex-shrink:0;}
  .sb-header{padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.08);display:flex;align-items:center;justify-content:space-between;}
  .sb-header span{font-size:13px;font-weight:600;color:rgba(255,255,255,0.7);}
  .sb-header button{background:rgba(255,255,255,0.08);border:none;color:rgba(255,255,255,0.6);padding:5px 10px;border-radius:6px;font-size:11px;font-family:inherit;cursor:pointer;}

  .dc{padding:14px 16px;border-bottom:1px solid rgba(255,255,255,0.05);cursor:pointer;transition:background 0.15s;}
  .dc:hover{background:rgba(255,255,255,0.04);}
  .dc-top{display:flex;align-items:center;gap:10px;margin-bottom:4px;}
  .dc-color{width:12px;height:12px;border-radius:50%;border:2px solid rgba(255,255,255,0.3);flex-shrink:0;}
  .dc-name{font-weight:600;font-size:14px;flex:1;}
  .dc-tag{font-size:9px;font-weight:700;padding:2px 7px;border-radius:8px;text-transform:uppercase;letter-spacing:0.5px;}
  .tag-live{background:rgba(76,175,80,0.2);color:#4CAF50;}
  .tag-wait{background:rgba(255,255,255,0.08);color:rgba(255,255,255,0.4);}
  .tag-done{background:rgba(184,150,46,0.2);color:var(--gold);}
  .dc-stats{display:flex;gap:14px;font-size:11px;color:rgba(255,255,255,0.45);margin-top:2px;}
  .dc-stops{padding:4px 16px 10px;}
  .stop-row{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:12px;}
  .stop-num{width:18px;height:18px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:700;color:white;flex-shrink:0;}
  .stop-name{flex:1;color:rgba(255,255,255,0.7);}
  .stop-done{opacity:0.35;text-decoration:line-through;}

  .map-wrap{flex:1;position:relative;}
  #map{width:100%;height:100%;}
  .overlay-stats{position:absolute;top:12px;left:12px;display:flex;gap:8px;z-index:10;flex-wrap:wrap;}
  .os{background:rgba(22,27,34,0.92);backdrop-filter:blur(8px);border:1px solid rgba(255,255,255,0.1);border-radius:var(--radius);padding:10px 14px;min-width:80px;}
  .os-val{font-size:22px;font-weight:700;}
  .os-lbl{font-size:9px;color:rgba(255,255,255,0.45);margin-top:2px;text-transform:uppercase;letter-spacing:0.5px;}

  .empty{padding:40px 20px;text-align:center;color:rgba(255,255,255,0.35);font-size:13px;line-height:1.6;}

  .sb-tabs{display:flex;border-bottom:1px solid rgba(255,255,255,0.08);}
  .sb-tab{flex:1;padding:10px;text-align:center;font-size:12px;font-weight:600;cursor:pointer;color:rgba(255,255,255,0.4);transition:all 0.2s;border-bottom:2px solid transparent;}
  .sb-tab.active{color:white;border-bottom-color:var(--gold);}
  .sb-tab:hover{color:rgba(255,255,255,0.7);}

  .pu-item{display:flex;align-items:center;gap:10px;padding:12px 16px;border-bottom:1px solid rgba(255,255,255,0.05);}
  .pu-icon{width:32px;height:32px;border-radius:50%;background:rgba(76,175,80,0.2);display:flex;align-items:center;justify-content:center;font-size:16px;flex-shrink:0;}
  .pu-info{flex:1;}
  .pu-name{font-weight:600;font-size:13px;}
  .pu-detail{font-size:11px;color:rgba(255,255,255,0.4);margin-top:1px;}
  .pu-time{font-size:11px;color:var(--green);font-weight:600;}

  .lock{min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--navy);}
  .lock-box{background:#161b22;border-radius:var(--radius);padding:40px;max-width:380px;width:90%;text-align:center;border:1px solid rgba(255,255,255,0.1);}
  .lock-box h2{font-size:18px;margin-bottom:4px;}
  .lock-box p{font-size:13px;color:rgba(255,255,255,0.5);margin-bottom:24px;}
  .lock-box input{width:100%;padding:14px 48px 14px 14px;border:1.5px solid rgba(255,255,255,0.15);border-radius:var(--radius);font-family:inherit;font-size:15px;text-align:center;outline:none;background:rgba(255,255,255,0.05);color:white;margin-bottom:12px;}
  .lock-box input:focus{border-color:var(--gold);}
  .lock-err{font-size:12px;color:var(--red);margin-bottom:12px;display:none;}
  .btn-gold{background:var(--gold);color:white;border:none;border-radius:var(--radius);cursor:pointer;font-family:inherit;font-weight:600;transition:all 0.2s;}
  .btn-gold:hover{background:var(--gold-light);}

  @media(max-width:768px){
    .layout{flex-direction:column-reverse;}
    .sidebar{width:100%;height:40vh;border-right:none;border-top:1px solid rgba(255,255,255,0.08);}
    .map-wrap{height:60vh;}
  }
</style>
</head>
<body>

<!-- PASSWORD -->
<div id="lockScreen" class="lock">
  <div class="lock-box">
    <div style="font-size:40px;margin-bottom:12px;">üõ∞Ô∏è</div>
    <h2>Command Center</h2>
    <p>RCC Transportation ‚Äî Live Fleet Overview</p>
    <div style="position:relative;">
      <input type="password" id="pinInput" placeholder="Enter password" maxlength="50"
        onkeydown="if(event.key==='Enter')checkPin()" autofocus>
      <button type="button" onclick="togglePwd()" id="toggleBtn"
        style="position:absolute;right:12px;top:14px;background:none;border:none;cursor:pointer;font-size:18px;color:rgba(255,255,255,0.4);padding:0;">üëÅÔ∏è</button>
    </div>
    <div class="lock-err" id="pinError">Incorrect password.</div>
    <button class="btn-gold" onclick="checkPin()" style="width:100%;padding:14px;font-size:15px;">Enter Command Center</button>
  </div>
</div>

<!-- DASHBOARD -->
<div id="mainDash" style="display:none;">
  <div class="header">
    <div><h1>üõ∞Ô∏è Command Center</h1><div class="sub">Redeemers Church of Christ ‚Äî Transportation Fleet</div></div>
    <div class="hdr-right">
      <div class="live-badge badge-wait" id="liveBadge">‚óè CONNECTING</div>
      <span class="clock" id="clock"></span>
    </div>
  </div>
  <div class="layout">
    <div class="sidebar">
      <div class="sb-header"><span id="sbTitle">Loading...</span><button onclick="refreshNow()">üîÑ</button></div>
      <div class="sb-tabs">
        <div class="sb-tab active" id="tabDrivers" onclick="switchTab('drivers')">üöê Drivers</div>
        <div class="sb-tab" id="tabPickedUp" onclick="switchTab('pickedup')">‚úÖ Picked Up <span id="pickedUpBadge" style="background:var(--green);color:white;font-size:9px;padding:1px 6px;border-radius:8px;margin-left:4px;">0</span></div>
      </div>
      <div id="driverCards"><div class="empty">Connecting to server...</div></div>
      <div id="pickedUpList" style="display:none;"></div>
    </div>
    <div class="map-wrap">
      <div class="overlay-stats">
        <div class="os"><div class="os-val" id="sDrivers">-</div><div class="os-lbl">Drivers</div></div>
        <div class="os"><div class="os-val" id="sRiders">-</div><div class="os-lbl">Riders</div></div>
        <div class="os"><div class="os-val" id="sPickedUp">-</div><div class="os-lbl">Picked Up</div></div>
        <div class="os"><div class="os-val" id="sRemaining">-</div><div class="os-lbl">Remaining</div></div>
      </div>
      <div id="map"></div>
    </div>
  </div>
</div>

<script>
var PROXY = 'https://clickup-proxy.subscriptions-34a.workers.dev';
var CHURCH = { lat: 38.9847, lng: -76.8545 };
var PIN_HASH = '1a8dfb37bd160e058648cee3b48eeb75493d487d38411eed2d77bfab2fb8653b';

var map, churchMarker;
var driverMarkers = {};   // { driverName: { marker, color, infoWin } }
var stopMarkersList = []; // all stop markers
var activeSessionId = null;
var sessionDrivers = [];
var sessionRiders = [];
var pollTimer = null;

// ‚îÄ‚îÄ Auth ‚îÄ‚îÄ
function togglePwd() {
  var i = document.getElementById('pinInput'), b = document.getElementById('toggleBtn');
  if (i.type === 'password') { i.type = 'text'; b.textContent = 'üôà'; } else { i.type = 'password'; b.textContent = 'üëÅÔ∏è'; }
  i.focus();
}
async function checkPin() {
  var pin = document.getElementById('pinInput').value.trim();
  if (!pin) return;
  var buf = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(pin));
  var hash = Array.from(new Uint8Array(buf)).map(function(b) { return b.toString(16).padStart(2,'0'); }).join('');
  if (hash === PIN_HASH) { sessionStorage.setItem('rcc_cmd_auth','true'); boot(); }
  else { document.getElementById('pinError').style.display = ''; document.getElementById('pinInput').value = ''; }
}
if (sessionStorage.getItem('rcc_cmd_auth') === 'true') boot();

function boot() {
  document.getElementById('lockScreen').style.display = 'none';
  document.getElementById('mainDash').style.display = '';
  initMap();
  startClock();
  findActiveSession();
}

function startClock() {
  function u() { document.getElementById('clock').textContent = new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'}); }
  u(); setInterval(u, 1000);
}

// ‚îÄ‚îÄ Map ‚îÄ‚îÄ
function initMap() {
  map = new google.maps.Map(document.getElementById('map'), {
    center: CHURCH, zoom: 12,
    styles: [
      {elementType:'geometry',stylers:[{color:'#1d2c4d'}]},
      {elementType:'labels.text.fill',stylers:[{color:'#8ec3b9'}]},
      {elementType:'labels.text.stroke',stylers:[{color:'#1a3646'}]},
      {featureType:'road',elementType:'geometry',stylers:[{color:'#304a7d'}]},
      {featureType:'road',elementType:'geometry.stroke',stylers:[{color:'#255d99'}]},
      {featureType:'water',elementType:'geometry',stylers:[{color:'#17263c'}]},
      {featureType:'poi',stylers:[{visibility:'off'}]},
      {featureType:'transit',stylers:[{visibility:'off'}]},
    ],
    disableDefaultUI: true, zoomControl: true,
  });
  churchMarker = new google.maps.Marker({
    position: CHURCH, map: map, title: 'RCC ‚Äî 10001 Aerospace Rd',
    label: { text: '‚õ™', fontSize: '28px' },
    icon: { path: google.maps.SymbolPath.CIRCLE, scale: 0 },
  });
}

// ‚îÄ‚îÄ Find Active Session (from server, not localStorage) ‚îÄ‚îÄ
async function findActiveSession() {
  try {
    var res = await fetch(PROXY + '/tracking/active-session');
    var data = await res.json();

    if (!data.active) {
      document.getElementById('driverCards').innerHTML = '<div class="empty">No active tracking session.<br><br>A session starts when a driver generates routes in the Driver Dashboard.<br><br>This page auto-checks every 15 seconds.</div>';
      document.getElementById('liveBadge').className = 'live-badge badge-off';
      document.getElementById('liveBadge').textContent = '‚óã NO SESSION';
      // Keep checking for new sessions
      setTimeout(findActiveSession, 15000);
      return;
    }

    activeSessionId = data.sessionId;
    sessionDrivers = data.drivers || [];
    sessionRiders = data.riders || [];

    // Place stop markers on map
    placeStopMarkers();

    // Start polling driver locations
    if (pollTimer) clearInterval(pollTimer);
    pollAllDrivers();
    pollTimer = setInterval(pollAllDrivers, 4000);

  } catch (err) {
    document.getElementById('driverCards').innerHTML = '<div class="empty">Error connecting to server.<br>' + err.message + '</div>';
    setTimeout(findActiveSession, 10000);
  }
}

function refreshNow() {
  if (pollTimer) clearInterval(pollTimer);
  // Clear markers
  Object.keys(driverMarkers).forEach(function(k) { driverMarkers[k].marker.setMap(null); });
  driverMarkers = {};
  stopMarkersList.forEach(function(m) { m.setMap(null); });
  stopMarkersList = [];
  findActiveSession();
}

function placeStopMarkers() {
  var geocoder = new google.maps.Geocoder();
  sessionDrivers.forEach(function(driver) {
    (driver.stops || []).forEach(function(stop, si) {
      geocoder.geocode({ address: stop.address }, function(results, status) {
        if (status === 'OK' && results[0]) {
          var m = new google.maps.Marker({
            position: results[0].geometry.location,
            map: map,
            title: stop.name + '\n' + stop.address,
            label: { text: String(si + 1), color: 'white', fontSize: '10px', fontWeight: '700' },
            icon: {
              path: google.maps.SymbolPath.CIRCLE,
              scale: 12,
              fillColor: driver.color || '#888',
              fillOpacity: 0.8,
              strokeColor: 'white',
              strokeWeight: 2,
            },
            zIndex: 50,
          });
          stopMarkersList.push(m);
        }
      });
    });
  });
}

// ‚îÄ‚îÄ Poll All Driver Locations ‚îÄ‚îÄ
async function pollAllDrivers() {
  if (!activeSessionId) return;

  try {
    var res = await fetch(PROXY + '/tracking/all-drivers?sessionId=' + encodeURIComponent(activeSessionId));
    var data = await res.json();

    if (data.error === 'Session not found') {
      // Session ended by driver ‚Äî show final state but keep what we have
      document.getElementById('liveBadge').className = 'live-badge badge-off';
      document.getElementById('liveBadge').textContent = '‚óã SESSION ENDED';
      if (pollTimer) clearInterval(pollTimer);
      return;
    }

    var locations = data.locations || {};
    var pickups = data.pickups || {};
    var drivers = data.drivers || sessionDrivers;
    var riders = data.riders || sessionRiders;

    var anyLive = false;
    var pickedUpCount = Object.keys(pickups).length;
    var totalRiders = riders.length;

    // Update stats
    document.getElementById('sDrivers').textContent = drivers.length;
    document.getElementById('sRiders').textContent = totalRiders;
    document.getElementById('sPickedUp').textContent = pickedUpCount;
    document.getElementById('sRemaining').textContent = totalRiders - pickedUpCount;
    document.getElementById('pickedUpBadge').textContent = pickedUpCount;

    // ‚îÄ‚îÄ Build Drivers sidebar ‚îÄ‚îÄ
    var html = '';
    drivers.forEach(function(driver) {
      var loc = locations[driver.name];
      var isLive = loc && (Date.now() - loc.timestamp < 30000);
      var allPickedUp = true;

      if (isLive) anyLive = true;

      var tagClass = isLive ? 'tag-live' : 'tag-wait';
      var tagText = isLive ? 'LIVE' : 'WAITING';

      var stopsHtml = '';
      var driverPickedCount = 0;
      (driver.stops || []).forEach(function(stop, si) {
        var picked = !!pickups[stop.name];
        if (!picked) allPickedUp = false; else driverPickedCount++;
        stopsHtml += '<div class="stop-row' + (picked ? ' stop-done' : '') + '">' +
          '<div class="stop-num" style="background:' + (driver.color || '#888') + ';">' + (si + 1) + '</div>' +
          '<span class="stop-name">' + stop.name + '</span>' +
          '<span style="font-size:14px;">' + (picked ? '‚úÖ' : '‚è≥') + '</span>' +
        '</div>';
      });

      if (allPickedUp && (driver.stops || []).length > 0) {
        tagClass = 'tag-done';
        tagText = 'COMPLETE';
      }

      var lastUpdate = loc ? new Date(loc.timestamp).toLocaleTimeString() : '--';

      html += '<div class="dc" onclick="focusDriver(\'' + driver.name.replace(/'/g, "\\'") + '\')">' +
        '<div class="dc-top">' +
          '<div class="dc-color" style="background:' + (driver.color || '#888') + ';"></div>' +
          '<span class="dc-name">' + driver.name + '</span>' +
          '<span class="dc-tag ' + tagClass + '">' + tagText + '</span>' +
        '</div>' +
        '<div class="dc-stats">' +
          '<span>üìç ' + lastUpdate + '</span>' +
          '<span>üõ£Ô∏è ' + (driver.totalMiles || '-') + ' mi</span>' +
          '<span>‚úÖ ' + driverPickedCount + '/' + (driver.stops || []).length + '</span>' +
        '</div>' +
      '</div>' +
      '<div class="dc-stops">' + stopsHtml + '</div>';

      // Update/create map marker
      if (loc) {
        var driverLatLng = new google.maps.LatLng(loc.lat, loc.lng);

        if (!driverMarkers[driver.name]) {
          driverMarkers[driver.name] = {
            marker: new google.maps.Marker({
              position: driverLatLng, map: map, title: driver.name,
              icon: {
                path: 'M17.402,0H5.643C2.526,0,0,3.467,0,6.584v34.804c0,3.116,2.526,5.644,5.643,5.644h11.759c3.116,0,5.644-2.527,5.644-5.644V6.584C23.044,3.467,20.518,0,17.402,0z M22.057,14.188v11.665l-2.729,0.351v-4.806L22.057,14.188z M20.625,10.773c-1.016,3.9-2.219,8.51-2.219,8.51H4.638l-2.222-8.51C2.417,10.773,11.3,7.94,20.625,10.773z M3.748,21.713v4.492l-2.73-0.349V14.502L3.748,21.713z M1.018,37.938V27.579l2.73,0.343v8.196L1.018,37.938z M2.575,40.882l2.218-3.336h13.455l2.196,3.336H2.575z M22.057,37.882l-2.729,1.835v-8.196l2.729-0.343V37.882z',
                fillColor: driver.color || '#888', fillOpacity: 1,
                strokeColor: '#fff', strokeWeight: 1.5, scale: 0.5,
                anchor: new google.maps.Point(12, 24),
              },
              zIndex: 100,
            }),
            color: driver.color,
          };
          var iw = new google.maps.InfoWindow({
            content: '<div style="font-family:Outfit;font-size:13px;color:#1B2040;padding:4px;"><strong>üöê ' + driver.name + '</strong></div>',
          });
          (function(name, infoW) {
            driverMarkers[name].marker.addListener('click', function() { infoW.open(map, driverMarkers[name].marker); });
          })(driver.name, iw);
        } else {
          animateMarker(driverMarkers[driver.name].marker, driverMarkers[driver.name].marker.getPosition(), driverLatLng);
        }
      }
    });

    document.getElementById('sbTitle').textContent = drivers.length + ' Driver' + (drivers.length !== 1 ? 's' : '');
    document.getElementById('driverCards').innerHTML = html;

    // ‚îÄ‚îÄ Build Picked Up list ‚îÄ‚îÄ
    var puHtml = '';
    if (pickedUpCount === 0) {
      puHtml = '<div class="empty">No riders picked up yet.</div>';
    } else {
      // Match pickups to rider info
      riders.forEach(function(rider) {
        var pu = pickups[rider.name];
        if (!pu) return;
        var puTime = new Date(pu.timestamp).toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
        var driverName = rider.driverName || '--';
        // Find driver color
        var dColor = '#888';
        drivers.forEach(function(d) { if (d.name === driverName) dColor = d.color || '#888'; });

        puHtml += '<div class="pu-item">' +
          '<div class="pu-icon">‚úÖ</div>' +
          '<div class="pu-info">' +
            '<div class="pu-name">' + rider.name + '</div>' +
            '<div class="pu-detail">' + (rider.address || '') + '</div>' +
            '<div class="pu-detail">Driver: <span style="color:' + dColor + ';font-weight:600;">' + driverName + '</span></div>' +
          '</div>' +
          '<div class="pu-time">' + puTime + '</div>' +
        '</div>';
      });
    }
    document.getElementById('pickedUpList').innerHTML = puHtml;

    // Live badge
    if (anyLive) {
      document.getElementById('liveBadge').className = 'live-badge badge-live';
      document.getElementById('liveBadge').textContent = '‚óè LIVE';
    } else {
      document.getElementById('liveBadge').className = 'live-badge badge-wait';
      document.getElementById('liveBadge').textContent = '‚óè WAITING';
    }

    // Fit map
    var bounds = new google.maps.LatLngBounds();
    bounds.extend(CHURCH);
    Object.keys(driverMarkers).forEach(function(n) { bounds.extend(driverMarkers[n].marker.getPosition()); });
    if (Object.keys(driverMarkers).length > 0 && !userPannedMap) map.fitBounds(bounds, 80);

  } catch (err) {
    console.warn('Poll error:', err);
  }
}

var userPannedMap = false;
// Stop auto-fitting after user manually interacts with map
function initMapListeners() {
  if (!map) return;
  google.maps.event.addListener(map, 'dragstart', function() { userPannedMap = true; });
}
setTimeout(initMapListeners, 2000);

function switchTab(tab) {
  if (tab === 'drivers') {
    document.getElementById('tabDrivers').classList.add('active');
    document.getElementById('tabPickedUp').classList.remove('active');
    document.getElementById('driverCards').style.display = '';
    document.getElementById('pickedUpList').style.display = 'none';
  } else {
    document.getElementById('tabDrivers').classList.remove('active');
    document.getElementById('tabPickedUp').classList.add('active');
    document.getElementById('driverCards').style.display = 'none';
    document.getElementById('pickedUpList').style.display = '';
  }
}

function focusDriver(name) {
  if (driverMarkers[name]) {
    map.panTo(driverMarkers[name].marker.getPosition());
    map.setZoom(14);
  }
}

function animateMarker(marker, from, to) {
  var steps = 15, step = 0;
  var fLat = from.lat(), fLng = from.lng(), tLat = to.lat(), tLng = to.lng();
  var t = setInterval(function() {
    step++;
    var p = step / steps;
    marker.setPosition(new google.maps.LatLng(fLat + (tLat - fLat) * p, fLng + (tLng - fLng) * p));
    if (step >= steps) clearInterval(t);
  }, 60);
}
</script>
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyD6aFSYheMeqE7NUs3zZolyxPojLQuTqg4&libraries=places,directions&callback=Function.prototype"></script>
</body>
</html>
